<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KnaveTone âš¡ | Checkout</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&family=Poppins:wght@300;500&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <!-- Leaflet CSS (no integrity/crossorigin to avoid blocking) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    #map {
      height: 400px;
      border-radius: 8px;
      border: 1px solid rgba(0,255,255,0.4);
      box-shadow: 0 0 15px rgba(0,255,255,0.2);
    }
  </style>
</head>
<body class="bg-dark text-light">
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">KnaveTone âš¡</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-center" id="navAuthLinks"></ul>
      </div>
    </div>
  </nav>

  <div class="container py-3">
    <button onclick="window.history.back()" class="btn btn-sm btn-outline-info mb-3 d-flex align-items-center">
      <i class="bi bi-arrow-left me-2"></i> Go Back
    </button>
    
    <nav aria-label="breadcrumb">
  <ol id="breadcrumb"></ol>
</nav>
  </div>

  <section class="container py-5">
    <h1 class="text-warning mb-4 display-4 font-orbitron">Checkout</h1>

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card card-cyber p-3 mb-4">
          <h5 class="text-info mb-3">Selected Items</h5>
          <ul id="checkoutItems" class="list-group list-group-flush bg-transparent"></ul>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card card-cyber p-3">
          <h5 class="text-info mb-3">Choose Delivery Location</h5>

<!-- ðŸ” Search bar -->
<div class="input-group mb-2">
  <input type="text" id="locationSearchInput" class="form-control bg-dark text-light"
         placeholder="Search for a city, address, or country">
  <button class="btn btn-outline-info" id="locationSearchBtn">
    <i class="bi bi-search"></i>
  </button>
</div>

<p class="text-light-muted small mb-2">
  Click on the world map or search for a location to set your delivery point.
</p>

<div id="map"></div>

<p class="mt-3 small">
  <strong>Selected Coordinates:</strong>
  <span id="coordsText" class="text-info">None</span>
</p>

<button id="confirmOrderBtn" class="btn btn-warning fw-bold mt-2" disabled>
  <i class="bi bi-check2-circle me-2"></i> Confirm Order
</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Bootstrap & Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Reuse global config (API_BASE_URL, etc.) -->
  <script>
  //const API_BASE_URL = "http://localhost:5000";
  const API_BASE_URL = "https://mongodb-crud-api-azs9.onrender.com";
  const USERS_URL = `${API_BASE_URL}/api/users`;
  const PROFILE_URL = `${USERS_URL}/profile`;
  const ORDER_URL = `${API_BASE_URL}/api/orders`; // ðŸ‘ˆ needed
</script>
<script src="index.js"></script>

<!-- Breadcrumb config + helper -->
  <script>
    window.BREADCRUMB = [
      { label: 'Home', href: 'index.html' },
      { label: 'Products', href: 'product.html' },
      { label: 'Your Cart', href: 'cart.html' },
      { label: 'Checkout', href: null }
    ];
  </script>
  <script src="breadcrumb.js"></script>

  <script>
    // Simple checkout logic for selected products and map

    function getToken() {
      return localStorage.getItem("knavetoneToken");
    }

    async function loadSelectedItems() {
      const params = new URLSearchParams(window.location.search);
      const selectedIds = params.getAll('id'); // multiple id params

      const token = getToken();
      if (!token) {
        alert("You must be logged in to checkout.");
        window.location.href = "index.html";
        return;
      }

      try {
        const res = await fetch(CART_URL, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const serverCart = await res.json();

        const selectedItems = serverCart
          .filter(item => selectedIds.includes(item.productId._id))
          .map(item => ({
            id: item.productId._id,
            name: item.productId.name,
            quantity: item.quantity,
            price: item.productId.price
          }));

        const listEl = document.getElementById('checkoutItems');
        if (selectedItems.length === 0) {
          listEl.innerHTML = '<li class="list-group-item bg-transparent text-warning">No items selected or items no longer in cart.</li>';
          return;
        }

        listEl.innerHTML = selectedItems.map(i => `
          <li class="list-group-item bg-transparent d-flex justify-content-between">
            <span>${i.name} <span class="badge bg-secondary ms-2">x${i.quantity}</span></span>
            <span class="text-info">$${(i.price * i.quantity).toFixed(2)}</span>
          </li>
        `).join('');
      } catch (err) {
        console.error("Error loading checkout items:", err);
        const listEl = document.getElementById('checkoutItems');
        listEl.innerHTML = '<li class="list-group-item bg-transparent text-danger">Failed to load selected items.</li>';
      }
    }

    function initMap() {
  const map = L.map('map').setView([20, 0], 2); // world view

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let marker = null;
  const coordsText = document.getElementById('coordsText');
  const confirmBtn = document.getElementById('confirmOrderBtn');
  const searchInput = document.getElementById('locationSearchInput');
  const searchBtn = document.getElementById('locationSearchBtn');

  function setLocation(lat, lng, label) {
    const latlng = L.latLng(lat, lng);
    if (marker) {
      marker.setLatLng(latlng);
    } else {
      marker = L.marker(latlng).addTo(map);
    }
    map.setView(latlng, 10); // zoom in

    coordsText.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}${label ? ' (' + label + ')' : ''}`;
    confirmBtn.removeAttribute('disabled');
    localStorage.setItem('knavetoneCheckoutCoords', JSON.stringify({ lat, lng, label }));
  }

  // Click on map to set location
  map.on('click', (e) => {
    const { lat, lng } = e.latlng;
    setLocation(lat, lng, '');
  });

  // ðŸ” Search by text using Nominatim (OpenStreetMap)
  async function searchLocation() {
    const query = (searchInput.value || '').trim();
    if (!query) return;

    try {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
      const res = await fetch(url, { headers: { 'Accept-Language': 'en' }});
      const results = await res.json();

      if (!Array.isArray(results) || results.length === 0) {
        alert('Location not found. Try a different search.');
        return;
      }

      const best = results[0]; // take top result
      const lat = parseFloat(best.lat);
      const lon = parseFloat(best.lon);
      const label = best.display_name || query;

      setLocation(lat, lon, label);
    } catch (err) {
      console.error("Geocoding error:", err);
      alert('Failed to search location. Please try again.');
    }
  }

  if (searchBtn && searchInput) {
    searchBtn.addEventListener('click', (e) => {
      e.preventDefault();
      searchLocation();
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchLocation();
      }
    });
  }

  // Confirm button: create order on server and redirect
confirmBtn.addEventListener('click', async () => {
  const coordsRaw = localStorage.getItem('knavetoneCheckoutCoords');
  if (!coordsRaw) {
    alert('Please select a location on the map.');
    return;
  }

  const coords = JSON.parse(coordsRaw);

  // Get selected product IDs from query string
  const params = new URLSearchParams(window.location.search);
  const itemIds = params.getAll('id'); // multiple ?id=... from cart

  if (itemIds.length === 0) {
    alert('No items selected for order.');
    return;
  }

  const token = localStorage.getItem('knavetoneToken');
  if (!token) {
    alert('Session expired. Please log in again.');
    window.location.href = 'index.html';
    return;
  }

  try {
    const res = await fetch(ORDER_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ itemIds, coords })
    });

    const data = await res.json();
    if (res.ok) {
      alert('Order placed successfully!');
      // âœ… redirect to My Orders page (or somewhere else if you prefer)
      window.location.href = 'orders.html';
    } else {
      alert(data.message || 'Failed to place order.');
    }
  } catch (err) {
    console.error('Order create error:', err);
    alert('Network error while placing order.');
  }
});
}

    document.addEventListener("DOMContentLoaded", async () => {
      await loadSelectedItems();
      initMap();
    });
  </script>
</body>
</html>